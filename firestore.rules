rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }
    
    function getUserId() {
      return request.auth.uid;
    }
    
    function isOwner(userId) {
      return isSignedIn() && getUserId() == userId;
    }
    
    function isProjectMember(projectData) {
      return isSignedIn() && (
        projectData.ownerId == getUserId() ||
        getUserId() in projectData.teamMemberIds
      );
    }
    
    // Users Collection
    match /users/{userId} {
      // Herkes kendi kullanıcı bilgilerini okuyabilir ve güncelleyebilir
      allow read, write: if isOwner(userId);
      
      // Diğer kullanıcıların e-posta ile aranabilmesi için
      allow get: if isSignedIn();
    }
    
    // Projects Collection (Root Level)
    match /projects/{projectId} {
      // Okuma: Proje sahibi veya ekip üyesi
      allow read: if isSignedIn() && (
        resource.data.ownerId == getUserId() ||
        getUserId() in resource.data.teamMemberIds
      );
      
      // Oluşturma: Giriş yapmış herkes
      allow create: if isSignedIn() && 
        request.resource.data.ownerId == getUserId();
      
      // Güncelleme: Proje sahibi veya ekip lideri veya ekip üyesi
      allow update: if isSignedIn() && (
        resource.data.ownerId == getUserId() ||
        getUserId() in resource.data.teamMemberIds
      );
      
      // Silme: Sadece proje sahibi
      allow delete: if isSignedIn() && 
        resource.data.ownerId == getUserId();
      
      // Tasks Sub-collection
      match /tasks/{taskId} {
        allow read, write: if isSignedIn() && (
          get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId == getUserId() || 
          getUserId() in get(/databases/$(database)/documents/projects/$(projectId)).data.teamMemberIds
        );
      }
    }
    
    // Notifications Collection
    match /notifications/{notificationId} {
      // Okuma: Sadece bildirim sahibi
      allow read: if isSignedIn() && 
        resource.data.userId == getUserId();
      
      // Oluşturma: Giriş yapmış herkes (sistem bildirimleri için)
      allow create: if isSignedIn();
      
      // Güncelleme: Sadece bildirim sahibi (okundu işaretlemek için)
      allow update: if isSignedIn() && 
        resource.data.userId == getUserId();
      
      // Silme: Sadece bildirim sahibi
      allow delete: if isSignedIn() && 
        resource.data.userId == getUserId();
    }
    
    // Invitations Collection
    match /invitations/{invitationId} {
      // Okuma: Gönderen veya alıcı
      allow read: if isSignedIn() && (
        resource.data.senderId == getUserId() ||
        resource.data.receiverId == getUserId()
      );
      
      // Oluşturma: Giriş yapmış herkes
      allow create: if isSignedIn();
      
      // Güncelleme: Sadece alıcı (kabul/red için)
      allow update: if isSignedIn() && 
        resource.data.receiverId == getUserId();
      
      // Silme: Gönderen veya alıcı
      allow delete: if isSignedIn() && (
        resource.data.senderId == getUserId() ||
        resource.data.receiverId == getUserId()
      );
    }
    
    // Email Notification Queue
    match /emailNotificationQueue/{queueId} {
      // Okuma: Sadece kendi e-posta bildirimlerini
      allow read: if isSignedIn() && 
        resource.data.userId == getUserId();
      
      // Oluşturma: Sadece kendi e-posta bildirimi için
      allow create: if isSignedIn() && 
        request.resource.data.userId == getUserId();
      
      // Güncelleme: Backend (Cloud Functions) için - admin erişimi gerekli
      allow update: if false;
      
      // Silme: Backend tarafından yapılacak
      allow delete: if false;
    }
    
    // Default: Tüm diğer işlemler reddedilir
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
